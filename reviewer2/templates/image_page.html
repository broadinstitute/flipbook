<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="width=device-width, initial-scale=1" charset="utf-8" name="viewport" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-serialize-object/2.5.0/jquery.serialize-object.min.js"></script>

    <link rel="icon" href="/favicon2.png" type="image/x-icon"/>
    <title>reviewer2: {{ relative_directory }}</title>
    <style>
        .img-default-view {
            cursor: zoom-in;
            max-width: 100% !important;
        }
        .img-zoomed-in-view {
            cursor: zoom-out;
        }
        .ui.grid>.row>.column>img, .ui.grid>.row>img {
            max-width: unset;
        }
        .keyboard-shortcut {
            border-color: rgba(0, 0, 0, 0.55);
            border-style: solid;
            border-width: 1px;
            border-radius: 5px;
            padding: 1px 4px 2px;
            margin-left: 0.5em;
            color: rgba(0, 0, 0, 0.55);
            font-size: 0.8em;
        }
        .disabled-link {
            color: #AAA;
            pointer-events: none;
        }
    </style>
</head>
<body style="overflow-x: scroll">
    {% set tabindex = 0 %}
    <div class="ui stackable grid" style="margin-top: 1px">
        <div class="row">
            <div class="one wide column"></div>
            <div class="fourteen wide column">
                <div class="ui stackable grid">
                    <div class="row">
                        <div class="three wide column" style="white-space: nowrap">
                            <a id="prevlink"
                               href="{{ get_image_page_url(i - 1, last) if i > 1  else '#' }}"
                               class="{{ '' if i > 1  else 'disabled-link' }}"
                               style="white-space: nowrap">
                                <span style="margin-right: 10px" class="keyboard-shortcut">&lt; or [</span>
                                <i class="arrow left icon"></i> &nbsp; prev
                            </a>
                            &nbsp; &nbsp;
                            <a id="nextlink"
                               href="{{ get_image_page_url(i + 1, last) if i < last else '#' }}"
                               class="{{ '' if i < last else 'disabled-link' }}"
                               style="white-space: nowrap">
                                next &nbsp; <i class="arrow right icon"></i>
                                <span style="margin-left: 10px" class="keyboard-shortcut">] or &gt;</span>
                            </a>
                        </div>
                        <div class="three wide column">
                            <span style="margin-left: 30px">
                                <a id="homelink" href="/" style="white-space: nowrap">
                                    <i class="home icon"></i> &nbsp; table
                                    <span style="margin-left: 10px" class="keyboard-shortcut">h or t</span>
                                </a>
                            </span>
                        </div>
                        <div class="four wide column" style="text-align:center">
                            <b>page #{{ i }} of {{ last }}: &nbsp; {{ relative_directory }}</b>
                        </div>
                        <div class="six wide column"></div>
                    </div>
                </div>
                {% if metadata_json|length > 0 %}
                    <div class="ui divider"></div>
                    {% for key, value in metadata_json.items() %}
                        <div style="margin-left: 10px; display: inline-block"><b>{{ key }}</b>: {{ value }}</div>
                    {% endfor %}
                {% endif %}
                {% if form_schema %}
                    <div class="ui divider"></div>
                    <form class="ui form" onsubmit="return false">
                        <input type="hidden" name="relative_directory" value="{{ relative_directory }}" />
                        <div class="inline fields" style="white-space: nowrap">
                            {% set is_first_iter = True %}
                            {% for form_schema_row in form_schema %}
                                {% if form_schema_row["type"] == "radio" %}
                                    <label for="{{ form_schema_row['name'] }}" style="margin-left: {{ 10 if is_first_iter else 35 }}px">
                                        {{ form_schema_row['inputLabel'] }}
                                    </label>
                                    {% for choice in form_schema_row['choices'] %}
                                        <div class="field">
                                            <div class="ui radio checkbox">
                                                <input type="radio"
                                                       name="{{ form_schema_row['name'] }}"
                                                       value="{{ choice['value'] }}"
                                                       class="hidden"
                                                       tabindex="{{ tabindex }}"
                                                       autofocus
                                                       {{ "checked" if form_responses.get(form_schema_row['columnName']) == choice['value'] else "" }}
                                                >
                                                <label>{{ choice['label'] }}</label>
                                            </div>
                                        </div>
                                        {% set tabindex = tabindex + 1 %}
                                    {% endfor %}
                                {% elif form_schema_row["type"] == "text" %}
                                    <div class="field" style="margin-left: 35px">
                                        <input type="text"
                                               name="{{ form_schema_row['name'] }}"
                                               size="{{ form_schema_row.get('size', 100) }}"
                                               placeholder="{{ form_schema_row['columnName'] }}"
                                               value="{{ form_responses.get(form_schema_row['columnName']) or '' }}"
                                               tabindex="{{ tabindex }}"
                                               autofocus
                                        >
                                    </div>
                                    {% set tabindex = tabindex + 1 %}
                                {% endif %}
                                {% set is_first_iter = False %}
                            {% endfor %}
                            <div id="save-status" style="display:none">
                                <i class="icon"></i>
                                <span></span>
                            </div>
                            <!-- div style="margin: 15px 0px 15px 35px" class="ui submit button">Save</div -->
                        </div>
                    </form>
                {% endif %}
                {% for image_path in image_paths %}
                    <div class="ui divider"></div>
                    <div style="margin: 10px"><b>{{ image_path }}</b></div>
                    <img class="img-default-view" src="/{{ image_path }}" tabindex="{{ tabindex }}"/>
                    {% set tabindex = tabindex + 1 %}
                {% endfor %}
            </div>
            <div class="one wide column"></div>
        </div>
    </div>
    <script type="text/javascript">
      //misc. init
      $('.ui.radio.checkbox').checkbox();

      $('.img-default-view').on('keypress click', (event) => {
        if (event.type === 'click' || event.which === 13 || event.which === 32 || event.which === 43 || event.which === 35) {
            $(event.target).toggleClass('img-default-view img-zoomed-in-view')
        }
      })

      //form submission
      const apiSpec = {
        url: '/save',
        interruptRequests: true,
        method : 'POST',
        on: 'keypress change',
        serializeForm: true,
        throttleFirstRequest: false,
        throttle: 300,
        onRequest: function(request) {
          $('#save-status i').attr('class', 'spinner loading icon')
          $('#save-status i').attr('style', 'color:#666666')
          $('#save-status span').text('Saving...')
          $('#save-status').show()
        },
        onComplete: function(response) {
          // always called after XHR complete
          $('#save-status').delay(500).fadeOut('slow');
        },
        onSuccess: function(response) {
          // valid response and response.success = true
          //console.log("onSuccess", response)
          $('#save-status i').attr('class', 'check circle icon')
          $('#save-status i').attr('style', 'color:#00AA00')
          $('#save-status span').text('Saved')
          $('#save-status').show()
        },
        onFailure: function(response) {
          // request failed, or valid response but response.success = false
          //console.log("onFailure", response)
          $('#save-status i').attr('class', 'exclamation circle icon')
          $('#save-status i').attr('style', 'color:#FF0000')
          $('#save-status span').text(`Couldn't save ${response.error}`)
          $('#save-status').show()
        },
      }
      $('form input[type=text]').api(apiSpec)
      $('.form .ui.radio').api(apiSpec)
      //$('form .submit.button').api(apiSpec)

      //keyboard shortcuts
      $(document).keypress((event) => {
        if ((event.target.tagName || '').toLowerCase() == 'input' && event.target.type == 'text') {
            return
        }
        const keyToSelectorMap = {
          '[': "#prevlink",
          '<': "#prevlink",
          'p': "#prevlink",
          'P': "#prevlink",
          ']': "#nextlink",
          '>': "#nextlink",
          'n': "#nextlink",
          'N': "#nextlink",
          'h': "#homelink",
          't': "#homelink",
        }
        const key = String.fromCharCode(event.keyCode)
        const selector = keyToSelectorMap[key]
        if (selector) {
            const obj = $(selector)
            if (obj.length > 0) {
              obj[0].click()
            }
        }
      })
    </script>
</body>
</html>
